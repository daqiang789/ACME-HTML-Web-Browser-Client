
# 宝塔面板部署指南

本指南详细说明如何在宝塔面板中部署商用SSL证书申请系统。

## 系统要求

- 宝塔面板 7.0+
- Node.js 14+ (通过宝塔PM2管理器安装)
- MySQL 5.7+ 或 MariaDB 10.3+
- 服务器内存 1GB+
- 磁盘空间 5GB+

---

## 第一步：安装必要软件

### 1.1 安装MySQL数据库

1. 登录宝塔面板
2. 点击左侧菜单 **软件商店**
3. 搜索 **MySQL** 或 **MariaDB**
4. 点击 **安装**，选择推荐版本（MySQL 5.7 或 MariaDB 10.3）
5. 等待安装完成

### 1.2 安装PM2管理器

1. 在软件商店搜索 **PM2管理器**
2. 点击 **安装**
3. 安装完成后，PM2会自动安装Node.js

### 1.3 安装Nginx（可选，用于反向代理）

1. 在软件商店搜索 **Nginx**
2. 点击 **安装**
3. 选择推荐版本安装

---

## 第二步：创建数据库

### 2.1 通过宝塔面板创建数据库

1. 点击左侧菜单 **数据库**
2. 点击 **添加数据库**
3. 填写以下信息：
   - 数据库名：`ssl_system`
   - 用户名：`ssl_system`（或自定义）
   - 密码：**点击生成随机密码**（务必记录下来）
   - 访问权限：选择 **本地服务器**
4. 点击 **提交**

### 2.2 导入数据库表结构

**方式一：通过phpmyadmin导入（推荐）**

1. 在数据库列表中找到 `ssl_system`
2. 点击 **管理** 按钮（或点击phpmyadmin图标）
3. 进入phpmyadmin后，选择 `ssl_system` 数据库
4. 点击顶部的 **导入** 标签
5. 点击 **选择文件**，选择项目中的 `database.sql` 文件
6. 点击 **执行**
7. 看到成功提示即表示导入完成

**方式二：通过终端导入**

```bash
# SSH连接到服务器
cd /www/wwwroot/你的项目目录

# 导入SQL文件
mysql -u ssl_system -p ssl_system < database.sql
# 输入密码后回车
```

### 2.3 验证数据库

在phpmyadmin中检查是否有以下7个表：
- ✅ admins（管理员表）
- ✅ api_keys（API密钥表）
- ✅ certificates（证书表）
- ✅ eab_credentials（EAB凭据表）
- ✅ acme_channels（ACME渠道表）
- ✅ operation_logs（操作日志表）
- ✅ system_configs（系统配置表）

---

## 第三步：上传项目文件

### 3.1 创建网站目录

1. 点击左侧菜单 **文件**
2. 进入 `/www/wwwroot/` 目录
3. 点击 **新建目录**
4. 创建目录名：`ssl-system`（或自定义）

### 3.2 上传项目文件

**方式一：通过宝塔文件管理器上传**

1. 进入刚创建的 `ssl-system` 目录
2. 点击 **上传**
3. 将项目所有文件打包成zip压缩包
4. 上传zip文件
5. 右键点击zip文件，选择 **解压**
6. 解压完成后删除zip文件

**方式二：通过Git克隆（如果你的项目在Git仓库）**

```bash
cd /www/wwwroot
git clone 你的仓库地址 ssl-system
cd ssl-system
```

**方式三：通过FTP上传**

使用FTP客户端（如FileZilla）连接到服务器，上传所有文件到 `/www/wwwroot/ssl-system/`

### 3.3 验证文件结构

确保目录结构如下：
```
/www/wwwroot/ssl-system/
├── package.json
├── server.js
├── .env.example
├── database.sql
├── ACME-HTML-Web-Browser-Client.html
├── config/
│   └── database.js
├── middleware/
│   └── auth.js
├── routes/
│   ├── admin.js
│   ├── auth.js
│   ├── certificate.js
│   ├── config.js
│   ├── keys.js
│   └── proxy.js
├── scripts/
│   └── init-database.js
└── public/
    ├── index.html
    └── admin/
        └── index.html
```

---

## 第四步：配置环境变量

### 4.1 创建 .env 文件

1. 在项目根目录中，复制 `.env.example` 文件
2. 重命名为 `.env`
3. 编辑 `.env` 文件：

```bash
# 数据库配置（使用第二步创建的数据库信息）
DB_HOST=localhost
DB_PORT=3306
DB_USER=ssl_system
DB_PASSWORD=你在第二步设置的密码
DB_NAME=ssl_system

# JWT密钥（重要：生成随机字符串）
JWT_SECRET=你的随机密钥_至少32位字符
SESSION_SECRET=你的随机密钥_至少32位字符

# 管理员账号（首次登录用）
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin123456

# 服务器配置
PORT=3000
NODE_ENV=production
```

### 4.2 生成随机密钥

**在宝塔终端中执行：**
```bash
# 生成JWT_SECRET
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 生成SESSION_SECRET  
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

将生成的随机字符串复制到 `.env` 文件中对应位置。

---

## 第五步：安装依赖

### 5.1 通过终端安装

1. 点击左侧菜单 **终端**
2. 进入项目目录：
```bash
cd /www/wwwroot/ssl-system
```

3. 安装npm依赖：
```bash
npm install
```

4. 等待安装完成（可能需要5-10分钟）

### 5.2 初始化数据库

```bash
npm run init-db
```

看到成功提示后，数据库初始化完成。

---

## 第六步：配置PM2启动

### 6.1 通过PM2管理器添加项目

1. 点击左侧菜单 **PM2管理器**
2. 点击 **添加项目**
3. 填写以下信息：

| 项目 | 值 |
|------|-----|
| 项目名称 | `ssl-system` |
| 启动文件 | `/www/wwwroot/ssl-system/server.js` |
| 运行目录 | `/www/wwwroot/ssl-system` |
| 端口 | `3000` |
| 项目描述 | 商用SSL证书申请系统 |
| 运行模式 | fork |

4. 点击 **提交**
5. 系统会自动启动项目

### 6.2 检查运行状态

在PM2管理器中查看：
- 状态应该显示为 **运行中**（绿色）
- CPU和内存使用正常
- 点击 **日志** 查看是否有错误信息

---

## 第七步：配置Nginx反向代理（推荐）

### 7.1 创建网站

1. 点击左侧菜单 **网站**
2. 点击 **添加站点**
3. 填写信息：
   - 域名：`ssl.yourdomain.com`（你的域名）
   - 根目录：`/www/wwwroot/ssl-system/public`
   - PHP版本：**纯静态**
4. 点击 **提交**

### 7.2 配置反向代理

1. 在网站列表中找到刚创建的网站
2. 点击 **设置**
3. 点击 **反向代理**
4. 点击 **添加反向代理**
5. 填写信息：
   - 代理名称：`ssl-system`
   - 目标URL：`http://127.0.0.1:3000`
   - 发送域名：`$host`
6. 点击 **保存**

### 7.3 添加自定义配置

在反向代理的配置文件中，添加以下内容：

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;
}
```

### 7.4 配置SSL证书（强烈推荐）

1. 在网站设置中点击 **SSL**
2. 选择 **Let's Encrypt** 或上传你自己的证书
3. 勾选 **强制HTTPS**
4. 点击 **申请** 或 **保存**

---

## 第八步：配置防火墙

### 8.1 开放端口（如果不使用Nginx）

如果直接使用3000端口访问：

1. 点击左侧菜单 **安全**
2. 点击 **添加规则**
3. 填写信息：
   - 端口：`3000`
   - 协议：TCP
   - 策略：允许
4. 点击 **提交**

### 8.2 配置云服务器安全组

如果使用的是阿里云、腾讯云等：
- 需要在云控制台的安全组中开放3000端口（或80/443端口）

---

## 第九步：访问系统

### 9.1 访问地址

- **使用Nginx反向代理：** `https://你的域名.com`
- **直接访问：** `http://服务器IP:3000`

### 9.2 首次登录

1. 访问管理后台：`https://你的域名.com/admin`
2. 使用默认账号登录：
   - 用户名：`admin`
   - 密码：`admin123456`（或你在.env中设置的密码）

3. **重要：登录后立即修改密码！**

---

## 第十步：后续配置

### 10.1 创建API密钥

1. 登录管理后台
2. 进入 **API密钥管理**
3. 点击 **创建密钥**
4. 设置名称、使用次数、有效期
5. 保存后将密钥分发给用户

### 10.2 配置EAB凭据（ZeroSSL/Google）

1. 进入 **EAB凭据管理**
2. 点击 **添加凭据**
3. 选择渠道（ZeroSSL或Google）
4. 填写EAB KID和HMAC KEY
5. 保存

### 10.3 配置ACME渠道

1. 进入 **渠道管理**
2. 可以启用/禁用Let's Encrypt、ZeroSSL、Google
3. 调整显示顺序

---

## 常见问题解决

### 问题1：端口被占用

**错误信息：** `Error: listen EADDRINUSE: address already in use :::3000`

**解决方法：**
```bash
# 查找占用3000端口的进程
lsof -i:3000
# 或
netstat -tunlp | grep 3000

# 杀死进程
kill -9 进程ID
```

或者修改 `.env` 文件中的端口号。

### 问题2：数据库连接失败

**错误信息：** `Error: ER_ACCESS_DENIED_ERROR`

**解决方法：**
1. 检查 `.env` 文件中的数据库配置是否正确
2. 在宝塔数据库管理中检查用户权限
3. 尝试重新创建数据库用户

### 问题3：PM2启动失败

**解决方法：**
```bash
cd /www/wwwroot/ssl-system

# 查看详细错误日志
pm2 logs ssl-system

# 重启项目
pm2 restart ssl-system

# 查看进程状态
pm2 status
```

### 问题4：无法访问管理后台

**解决方法：**
1. 检查Nginx配置是否正确
2. 检查防火墙端口是否开放
3. 查看PM2日志排查错误
4. 检查 `.env` 文件配置

### 问题5：证书申请失败

**ZeroSSL跨域问题已修复：**
- 系统已内置ACME代理，自动解决跨域问题
- 无需用户手动操作

**IP证书申请问题已修复：**
- 系统自动识别IP地址
- 正确设置identifier类型为"ip"
- 自动过滤不支持的验证方式

---

## 性能优化建议